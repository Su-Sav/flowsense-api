 @startuml
!include <C4/C4_Container>

Person(cpi, "SAP CPI Integration Flow", "ruft /analyze-error auf")

System_Boundary(api, "FlowSense API") {
    Container(server, "Express Server", "Node.js/Express", "Entry point, Routing")
    Container(rl, "Rate Limiter", "Middleware", "120 req / 60s")
    Container(cb, "Circuit Breaker", "In-Memory", "Threshold/Cooldown")
    Container(ajv, "AJV Validator", "Schema Validation", "Strict JSON Schema check")
    Container(router, "Router", "Decision Logic", "Routed to LLM or Fallback")
    Container(fb, "Deterministic Fallback", "Rule-based", "Retry / Park / Incident")
}

System(xsuaa, "XSUAA (SAP BTP Auth)", "OAuth2 / JWT Scopes")
System(openai, "OpenAI Responses API", "Semantic Error Classification")

Rel(cpi, server, "HTTPS /analyze-error")
Rel(server, rl, "request")
Rel(rl, cb, "request")
Rel(cb, ajv, "request")
Rel(ajv, router, "request")
Rel(router, openai, "semantic classification")
Rel(router, fb, "fallback on timeout/schema fail")
Rel(server, xsuaa, "JWT check")
Rel(router, cpi, "structured JSON decision")
@enduml
